{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Checkout</h3>
            </div>
            <div class="card-body p-4">
                <form method="POST" id="checkoutForm" novalidate>
                    <!-- Pickup Time Section -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-clock me-2"></i><strong>Pickup Only:</strong> Select your preferred pickup time
                        slot
                    </div>

                    <h5 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Select Pickup Time</h5>
                    <div class="mb-4">
                        <label class="form-label">Pickup Time Slot <span class="text-danger">*</span></label>
                        <select name="pickup_time" class="form-select form-select-lg" required>
                            <option value="">Choose a time slot...</option>
                            {% for slot in time_slots %}
                            <option value="{{ slot }}">{{ slot }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>Available slots: 9:00 AM - 5:30 PM (20-minute
                            intervals)
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3"><i class="fas fa-list-alt me-2"></i>Order Summary</h5>
                    <div class="bg-light p-3 rounded mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span>₹{{ subtotal }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Platform & Preorder Fee (2%)</span>
                            <span>₹{{ platform_fee }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total Amount</strong>
                            <strong class="text-primary fs-5">₹{{ total }}</strong>
                        </div>
                    </div>

                    <h5 class="mb-3"><i class="fas fa-credit-card me-2"></i>Payment Details</h5>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>This is a simulated payment gateway. No real
                        money will be deducted.
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Card Number</label>
                        <input type="text" class="form-control" id="cardNumber" name="card_number"
                            placeholder="XXXX XXXX XXXX XXXX" maxlength="19" required>
                        <div class="invalid-feedback">
                            Please enter a valid 16-digit card number.
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Expiry Date</label>
                            <input type="text" class="form-control" id="expiryDate" name="expiry_date"
                                placeholder="MM/YY" maxlength="5" required>
                            <div class="invalid-feedback">
                                Please enter a valid expiry date (MM/YY).
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cvv" name="cvv" placeholder="123" maxlength="3"
                                required>
                            <div class="invalid-feedback">
                                Please enter a valid 3-digit CVV.
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <button type="submit" class="btn btn-success w-100 btn-lg">
                        <i class="fas fa-check-circle me-2"></i>Pay & Place Order
                    </button>
                    <a href="{{ url_for('main.cart') }}" class="btn btn-outline-secondary w-100 mt-2">
                        <i class="fas fa-arrow-left me-2"></i>Back to Cart
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('checkoutForm');
        const cardNumber = document.getElementById('cardNumber');
        const expiryDate = document.getElementById('expiryDate');
        const cvv = document.getElementById('cvv');

        // Format Card Number
        cardNumber.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 16) value = value.slice(0, 16);

            // Add spaces every 4 digits
            let formattedValue = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) formattedValue += ' ';
                formattedValue += value[i];
            }
            e.target.value = formattedValue;
        });

        // Format Expiry Date
        expiryDate.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 4) value = value.slice(0, 4);

            if (value.length >= 2) {
                e.target.value = value.slice(0, 2) + '/' + value.slice(2);
            } else {
                e.target.value = value;
            }
        });

        // Format CVV
        cvv.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 3) value = value.slice(0, 3);
            e.target.value = value;
        });

        // Form Validation
        form.addEventListener('submit', function (e) {
            let isValid = true;

            // Validate Card Number (must be 16 digits, ignoring spaces)
            const cardValue = cardNumber.value.replace(/\s/g, '');
            if (cardValue.length !== 16) {
                cardNumber.classList.add('is-invalid');
                isValid = false;
            } else {
                cardNumber.classList.remove('is-invalid');
            }

            // Validate Expiry Date
            const dateValue = expiryDate.value;
            const datePattern = /^(0[1-9]|1[0-2])\/([0-9]{2})$/;
            if (!datePattern.test(dateValue)) {
                expiryDate.classList.add('is-invalid');
                isValid = false;
            } else {
                expiryDate.classList.remove('is-invalid');
            }

            // Validate CVV
            if (cvv.value.length !== 3) {
                cvv.classList.add('is-invalid');
                isValid = false;
            } else {
                cvv.classList.remove('is-invalid');
            }

            if (!isValid) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    });
</script>
{% endblock %}